name: Update Wellness Plan Pricing

on:
  repository_dispatch:
    types: [update-pricing]

permissions:
  contents: write

jobs:
  update-pricing-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate payload structure
        run: |
          echo "ðŸ” Validating pricing data..."
          echo '${{ toJson(github.event.client_payload.data) }}' > /tmp/payload.json

          if ! jq -e '.plans' /tmp/payload.json > /dev/null; then
            echo "âŒ Missing required field: plans"
            exit 1
          fi

          if ! jq -e '.settings' /tmp/payload.json > /dev/null; then
            echo "âŒ Missing required field: settings"
            exit 1
          fi

          # Validate cancellation data exists for each plan (non-blocking)
          for plan in puppy canineAdult kitten felineAdult; do
            if ! jq -e ".plans.${plan}.cancellation" /tmp/payload.json > /dev/null 2>&1; then
              echo "âš ï¸ Warning: Missing cancellation data for ${plan}"
            else
              echo "âœ… Cancellation data present for ${plan}"
            fi
          done

          echo "âœ… Validation passed"

      - name: Update plans.json
        run: |
          echo "ðŸ“ Writing new pricing data..."
          echo '${{ toJson(github.event.client_payload.data) }}' | \
            jq '.' > wellness-plans-data/plans.json

      - name: Commit and push
        run: |
          git config user.name "Wellness Plans Bot"
          git config user.email "wellness-bot@github-actions"
          git add wellness-plans-data/plans.json
          git commit -m "${{ github.event.client_payload.commit_message }}"
          git push

          echo "âœ… Changes committed successfully"

      - name: Summary
        if: success()
        run: echo "ðŸŽ‰ Pricing update complete! Live on GitHub Pages in 30-60 seconds."
