<!DOCTYPE html>
<!--
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è  SECURITY WARNING ‚ö†Ô∏è
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ùå NEVER COMMIT TOKENS TO THIS FILE:
   ‚Ä¢ GitHub Personal Access Tokens (ghp_... or github_pat_...)
   ‚Ä¢ API keys, passwords, or credentials
   ‚Ä¢ Base64-encoded secrets

‚úÖ CURRENT ARCHITECTURE:
   ‚Ä¢ Workflow trigger token in browser localStorage only
   ‚Ä¢ Commits handled by GitHub Actions workflow
   ‚Ä¢ Token never appears in code

üö® IF TOKEN IN FILE: DO NOT COMMIT. Remove immediately and rotate token.

This is a PUBLIC repository.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellness Plans ‚Äî Unified Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --purple-500: #667eea;
            --purple-700: #764ba2;
            --purple-900: #4a3270;
            --gold-50: #fffbeb;
            --gold-100: #fef3c7;
            --gold-200: #fde68a;
            --gold-400: #fbbf24;
            --gold-500: #f59e0b;
            --gold-600: #d97706;
            --green-500: #059669;
            --green-600: #047857;
            --red-500: #dc2626;
            --red-600: #b91c1c;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.1);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.15);
            --shadow-xl: 0 20px 60px rgba(0,0,0,0.2);
            --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'DM Mono', 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: #f0f0f5;
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.5;
        }

        /* ‚îÄ‚îÄ Background Pattern ‚îÄ‚îÄ */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 0%, rgba(102,126,234,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 100%, rgba(118,75,162,0.06) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .app { position: relative; z-index: 1; }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .app-header {
            background: linear-gradient(135deg, var(--purple-500) 0%, var(--purple-700) 100%);
            color: white;
            padding: 28px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 24px rgba(102,126,234,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .app-header .logo {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.15);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .app-header h1 {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .app-header .subtitle {
            font-size: 13px;
            opacity: 0.75;
            font-weight: 400;
            margin-top: 1px;
        }

        .app-header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-meta {
            text-align: right;
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.6;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.15);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            backdrop-filter: blur(4px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            box-shadow: 0 0 6px rgba(74,222,128,0.5);
        }

        .header-link {
            color: rgba(255,255,255,0.85);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .header-link:hover { color: white; }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .btn {
            font-family: var(--font-body);
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--purple-500), var(--purple-700));
            color: white;
            padding: 10px 24px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.3);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(102,126,234,0.4);
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
        }

        .btn-outline {
            background: white;
            color: var(--gray-700);
            border: 1.5px solid var(--gray-200);
            padding: 6px 14px;
            font-size: 13px;
        }
        .btn-outline:hover {
            border-color: var(--purple-500);
            color: var(--purple-500);
            background: rgba(102,126,234,0.04);
        }

        .btn-ghost {
            background: transparent;
            color: rgba(255,255,255,0.85);
            padding: 8px 16px;
            font-size: 13px;
        }
        .btn-ghost:hover { background: rgba(255,255,255,0.1); color: white; }

        .btn-danger {
            background: var(--red-500);
            color: white;
            padding: 6px 14px;
            font-size: 13px;
        }
        .btn-danger:hover { background: var(--red-600); }

        .btn-add {
            background: var(--gray-50);
            color: var(--gray-600);
            border: 1.5px dashed var(--gray-300);
            padding: 6px 14px;
            font-size: 13px;
            border-radius: var(--radius-sm);
        }
        .btn-add:hover {
            border-color: var(--purple-500);
            color: var(--purple-500);
            background: rgba(102,126,234,0.04);
        }

        .btn-save-cost {
            background: var(--green-500);
            color: white;
            padding: 8px 20px;
            font-size: 14px;
        }
        .btn-save-cost:hover { background: var(--green-600); }

        /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
        .login-container {
            min-height: calc(100vh - 100px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .login-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 48px 40px;
            max-width: 440px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            text-align: center;
        }

        .login-card .lock-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--purple-500), var(--purple-700));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin: 0 auto 24px;
            box-shadow: 0 8px 24px rgba(102,126,234,0.3);
        }

        .login-card h2 {
            font-size: 22px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .login-card p {
            color: var(--gray-500);
            font-size: 14px;
            margin-bottom: 28px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: var(--font-mono);
            letter-spacing: 2px;
            text-align: center;
            transition: border-color 0.2s;
            margin-bottom: 20px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--purple-500);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        /* ‚îÄ‚îÄ Main Layout ‚îÄ‚îÄ */
        .main-content {
            max-width: 1100px;
            margin: 0 auto;
            padding: 32px 24px 80px;
            display: none;
        }

        .main-content.active { display: block; }

        /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
        .section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .section-header .icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .section-header .icon.purple {
            background: rgba(102,126,234,0.1);
        }

        .section-header .icon.blue {
            background: rgba(59,130,246,0.1);
        }

        .section-header .icon.amber {
            background: rgba(245,158,11,0.1);
        }

        .section-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .section-header .section-desc {
            color: var(--gray-400);
            font-size: 13px;
            margin-left: auto;
        }

        /* ‚îÄ‚îÄ Settings Row ‚îÄ‚îÄ */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .setting-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-100);
        }

        .setting-card label {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .setting-card .dollar { color: var(--gray-400); font-size: 18px; font-weight: 500; }

        .setting-card input[type="number"] {
            width: 100px;
            padding: 8px 10px;
            border: 1.5px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 600;
            font-family: var(--font-body);
            text-align: right;
        }

        .setting-card input:focus {
            outline: none;
            border-color: var(--purple-500);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        /* ‚îÄ‚îÄ Token Config ‚îÄ‚îÄ */
        .config-section {
            background: linear-gradient(135deg, #eff6ff, #f0f0ff);
            border: 1px solid #c7d2fe;
        }

        .token-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
        }

        .token-status {
            flex: 1;
            font-size: 14px;
            color: var(--gray-600);
        }

        .token-status strong {
            font-weight: 600;
        }

        .config-warning {
            margin-top: 12px;
            padding: 10px 14px;
            background: var(--gold-50);
            border-left: 3px solid var(--gold-500);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            font-size: 12px;
            color: var(--gray-600);
            line-height: 1.6;
        }

        /* ‚îÄ‚îÄ Species Section ‚îÄ‚îÄ */
        .species-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 17px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray-100);
        }

        .species-header .emoji { font-size: 22px; }

        /* ‚îÄ‚îÄ Plan Card ‚îÄ‚îÄ */
        .plan-card {
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .plan-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        .plan-card-header h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .plan-card-header .plan-icon {
            font-size: 22px;
        }

        /* ‚îÄ‚îÄ Base Cost ‚îÄ‚îÄ */
        .base-cost-bar {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 24px;
            background: linear-gradient(to right, var(--gray-50), white);
            border-bottom: 1px solid var(--gray-100);
        }

        .base-cost-bar label {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
        }

        .base-cost-bar .dollar {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-400);
        }

        .base-cost-bar input {
            width: 110px;
            padding: 8px 12px;
            border: 1.5px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 18px;
            font-weight: 600;
            font-family: var(--font-body);
            text-align: right;
        }

        .base-cost-bar input:focus {
            outline: none;
            border-color: var(--purple-500);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .base-cost-bar .permonth {
            font-size: 13px;
            color: var(--gray-400);
        }

        /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
        .plan-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 24px;
            border-bottom: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        .tab-btn {
            font-family: var(--font-body);
            padding: 8px 20px;
            border-radius: 20px;
            border: 1.5px solid transparent;
            background: transparent;
            color: var(--gray-500);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--gray-700);
            background: white;
        }

        .tab-btn.active-estimate {
            background: white;
            color: var(--purple-500);
            border-color: var(--purple-500);
            box-shadow: 0 1px 4px rgba(102,126,234,0.15);
        }

        .tab-btn.active-cancel {
            background: var(--gold-50);
            color: var(--gold-600);
            border-color: var(--gold-500);
            box-shadow: 0 1px 4px rgba(245,158,11,0.15);
        }

        /* ‚îÄ‚îÄ Tab Content ‚îÄ‚îÄ */
        .tab-content {
            padding: 20px 24px 24px;
            display: none;
        }

        .tab-content.active { display: block; }

        .tab-content.cancel-tab {
            background: linear-gradient(to bottom, var(--gold-50), white);
        }

        /* ‚îÄ‚îÄ Service Group ‚îÄ‚îÄ */
        .service-group {
            margin-bottom: 24px;
        }

        .service-group:last-child { margin-bottom: 0; }

        .service-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .service-group-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-400);
        }

        .service-group-title.estimate { color: var(--purple-500); }
        .service-group-title.cancel { color: var(--gold-600); }

        /* ‚îÄ‚îÄ Service Items ‚îÄ‚îÄ */
        .service-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
            padding: 12px 14px;
            background: white;
            border: 1px solid var(--gray-100);
            border-radius: var(--radius-md);
            margin-bottom: 6px;
            transition: border-color 0.15s;
        }

        .service-item:hover {
            border-color: var(--gray-300);
        }

        .service-item.cancel-item {
            background: white;
            border-color: rgba(245,158,11,0.15);
        }

        .service-item.cancel-item:hover {
            border-color: rgba(245,158,11,0.35);
        }

        .service-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 0;
        }

        .service-name-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-800);
            line-height: 1.3;
        }

        .service-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .service-code-badge {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 1px 7px;
            border-radius: 4px;
        }

        .service-note {
            font-size: 12px;
            color: var(--gray-400);
            font-style: italic;
        }

        .service-pricing {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            white-space: nowrap;
        }

        .price-monthly {
            font-size: 14px;
            font-weight: 600;
            color: var(--purple-500);
        }

        .price-retail {
            font-size: 14px;
            font-weight: 600;
            color: var(--green-500);
        }

        .price-label {
            font-size: 10px;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .service-qty-badge {
            font-size: 12px;
            color: var(--gray-500);
            background: var(--gray-50);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid var(--gray-100);
        }

        .service-actions {
            display: flex;
            gap: 4px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-200);
            background: white;
            color: var(--gray-500);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
        }

        .btn-icon:hover {
            border-color: var(--gray-300);
            color: var(--gray-700);
            background: var(--gray-50);
        }

        .btn-icon.delete:hover {
            border-color: var(--red-500);
            color: var(--red-500);
            background: #fef2f2;
        }

        /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 480px;
            width: 100%;
            box-shadow: var(--shadow-xl);
            animation: modalIn 0.2s ease-out;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: translateY(20px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 5px;
        }

        .form-group label .req {
            color: var(--red-500);
            margin-left: 2px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-family: var(--font-body);
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--purple-500);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .form-group .form-hint {
            font-size: 12px;
            color: var(--gray-400);
            margin-top: 4px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-100);
        }

        /* ‚îÄ‚îÄ Delete Modal ‚îÄ‚îÄ */
        .delete-modal .modal-card {
            max-width: 420px;
        }

        .delete-modal h3 {
            color: var(--red-500);
        }

        .delete-modal p {
            font-size: 14px;
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .delete-modal .warning-text {
            font-size: 12px;
            color: var(--gray-400);
        }

        /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            top: 90px;
            right: 24px;
            padding: 14px 22px;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            font-size: 14px;
            box-shadow: var(--shadow-lg);
            z-index: 300;
            animation: toastIn 0.3s ease-out;
            max-width: 360px;
        }

        .toast.success { background: var(--green-500); }
        .toast.error { background: var(--red-500); }
        .toast.info { background: #3b82f6; }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(80px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 12px;
                padding: 20px;
                text-align: center;
            }
            .app-header-right { flex-wrap: wrap; justify-content: center; }
            .main-content { padding: 16px 12px 60px; }
            .section { padding: 20px 16px; }
            .settings-grid { grid-template-columns: 1fr; }
            .plan-card-header { padding: 16px; }
            .plan-tabs { padding: 10px 16px; }
            .tab-content { padding: 16px; }
            .base-cost-bar { padding: 14px 16px; flex-wrap: wrap; }
            .service-item { grid-template-columns: 1fr; gap: 8px; }
            .service-actions { justify-self: start; }
            .form-row { grid-template-columns: 1fr; }
        }

        /* ‚îÄ‚îÄ Utility ‚îÄ‚îÄ */
        .hidden { display: none !important; }
    </style>
</head>
<body>
<div class="app">
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <header class="app-header">
        <div class="app-header-left">
            <div class="logo">üêæ</div>
            <div>
                <h1>Wellness Plans Admin</h1>
                <div class="subtitle">University Animal Clinic ‚Äî Unified Pricing Manager</div>
            </div>
        </div>
        <div class="app-header-right" id="headerControls" style="display:none;">
            <div class="header-meta">
                <div class="status-badge"><span class="status-dot"></span> Connected</div>
                <div id="lastUpdated" style="margin-top:4px;"></div>
            </div>
            <a href="#" class="header-link" id="auditLogLink" target="_blank">Audit Log ‚Üó</a>
            <button class="btn btn-ghost btn-sm" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <div class="lock-icon">üîê</div>
            <h2>Admin Access</h2>
            <p>Enter your password to manage wellness plan pricing across all tools.</p>
            <input type="password" id="passwordInput" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter') login()">
            <button class="btn btn-primary" onclick="login()" style="width:100%;justify-content:center;">Sign In</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="mainContent" class="main-content">
        <!-- ‚îÄ‚îÄ Global Settings ‚îÄ‚îÄ -->
        <div class="section">
            <div class="section-header">
                <div class="icon purple">‚öôÔ∏è</div>
                <h2>Global Settings</h2>
                <span class="section-desc">Enrollment fees applied to all plans</span>
            </div>
            <div class="settings-grid">
                <div class="setting-card">
                    <label>First Pet Enrollment Fee</label>
                    <span class="dollar">$</span>
                    <input type="number" id="enrollmentFeeFirst" step="0.01" min="0">
                    <button class="btn btn-save-cost btn-sm" onclick="saveSetting('enrollmentFeeFirst')">Save</button>
                </div>
                <div class="setting-card">
                    <label>Additional Pet Enrollment Fee</label>
                    <span class="dollar">$</span>
                    <input type="number" id="enrollmentFeeAdditional" step="0.01" min="0">
                    <button class="btn btn-save-cost btn-sm" onclick="saveSetting('enrollmentFeeAdditional')">Save</button>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Admin Config ‚îÄ‚îÄ -->
        <div class="section config-section">
            <div class="section-header">
                <div class="icon blue">üîß</div>
                <h2>Admin Configuration</h2>
            </div>
            <div class="token-row">
                <span class="token-status">Workflow Token: <strong id="tokenStatusText">Not configured</strong></span>
                <button class="btn btn-outline btn-sm" onclick="setupWorkflowToken()">Configure Token</button>
            </div>
            <div class="config-warning">
                <strong>Admin only:</strong> This token allows the portal to trigger automated pricing updates via GitHub Actions. Staff users do not need to configure this. See <code>ADMIN_SETUP.md</code> for instructions.
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Canine Plans ‚îÄ‚îÄ -->
        <div class="section">
            <div class="species-header"><span class="emoji">üêï</span> Canine Plans</div>
            <div id="caninePlans"></div>
        </div>

        <!-- ‚îÄ‚îÄ Feline Plans ‚îÄ‚îÄ -->
        <div class="section">
            <div class="species-header"><span class="emoji">üêà</span> Feline Plans</div>
            <div id="felinePlans"></div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EDIT/ADD SERVICE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="editServiceModal">
    <div class="modal-card">
        <h3 id="modalTitle">Edit Service</h3>

        <div class="form-group" id="fg_code">
            <label>Service Code <span class="req">*</span></label>
            <input type="text" id="modalServiceCode" placeholder="e.g., WPSPAYK9" maxlength="20" style="font-family:var(--font-mono);">
            <div class="form-hint">Covetrus service code. Must be unique within this plan.</div>
        </div>

        <div class="form-group">
            <label>Service Name <span class="req">*</span></label>
            <input type="text" id="modalServiceName" placeholder="e.g., Spay Surgery">
        </div>

        <div class="form-row" id="fg_estimate_fields">
            <div class="form-group">
                <label>Monthly Cost ($) <span class="req">*</span></label>
                <input type="number" id="modalServiceCost" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Quantity <span class="req">*</span></label>
                <input type="text" id="modalServiceQty" placeholder="e.g., 1, Unlimited">
            </div>
        </div>

        <div class="form-group" id="fg_qty_only" style="display:none;">
            <label>Quantity <span class="req">*</span></label>
            <input type="text" id="modalServiceQtyIncluded" placeholder="e.g., 1, 2, Unlimited, As Recommended">
        </div>

        <div class="form-group" id="fg_retail">
            <label>Retail Price ($) <span class="req">*</span></label>
            <input type="number" id="modalRetailPrice" step="0.01" min="0" placeholder="0.00">
            <div class="form-hint">Full retail value from Covetrus price list.</div>
        </div>

        <div class="form-group" id="fg_note">
            <label>Note <span style="color:var(--gray-400);font-weight:400;">(optional)</span></label>
            <input type="text" id="modalServiceNote" placeholder="e.g., Includes Pre-Op Blood Panel">
        </div>

        <div class="modal-footer">
            <button class="btn btn-outline btn-sm" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary btn-sm" id="modalSaveBtn" onclick="saveServiceEdit()">Save</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DELETE CONFIRMATION MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay delete-modal" id="deleteConfirmModal">
    <div class="modal-card">
        <h3>‚ö†Ô∏è Confirm Deletion</h3>
        <p id="deleteConfirmText"></p>
        <p class="warning-text">This change will be committed to GitHub immediately and cannot be undone through the admin interface.</p>
        <div class="modal-footer">
            <button class="btn btn-outline btn-sm" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger btn-sm" onclick="confirmDelete()">Delete Service</button>
        </div>
    </div>
</div>

<script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CONFIGURATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const GITHUB_OWNER = 'samsamanowitz';
    const GITHUB_REPO = 'Wellness-Plan-Estimates';
    const GITHUB_API = 'https://api.github.com';
    const PASSWORD_HASH = '81140101981a72c287f3d39c659410b9448d4d8260e3ea1fd539feb488877610';

    function getWorkflowToken() {
        return localStorage.getItem('workflow_trigger_token') || '';
    }

    function setupWorkflowToken() {
        const token = prompt(
            'üîß One-Time Setup: Workflow Trigger Token\n\n' +
            'Paste the fine-grained PAT (starts with "github_pat_"):\n\n' +
            'This only needs to be done once.\n\n' +
            'See ADMIN_SETUP.md for instructions.'
        );
        if (token && token.trim().startsWith('github_pat_')) {
            localStorage.setItem('workflow_trigger_token', token.trim());
            showToast('Setup complete! Token saved securely.', 'success');
            setTimeout(() => location.reload(), 1500);
        } else if (token) {
            showToast('Invalid token format. Must start with "github_pat_"', 'error');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let isAuthenticated = sessionStorage.getItem('adminAuth') === 'true';
    let plansData = null;
    let editingService = null;
    // { planKey, serviceId, mode, context }
    // mode: 'addEstIncluded'|'editEstIncluded'|'addEstOptional'|'editEstOptional'
    //       |'addCxlBundled'|'editCxlBundled'|'addCxlOptional'|'editCxlOptional'
    let deletingService = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUTH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function login() {
        const password = document.getElementById('passwordInput').value;
        if (!password) { showToast('Please enter your password', 'error'); return; }
        const hash = await hashPassword(password);
        if (hash === PASSWORD_HASH) {
            isAuthenticated = true;
            sessionStorage.setItem('adminAuth', 'true');
            await loadPlansData();
            showMainContent();
            showToast('Successfully logged in!', 'success');
            document.getElementById('passwordInput').value = '';
        } else {
            showToast('Incorrect password', 'error');
        }
    }

    function logout() {
        sessionStorage.removeItem('adminAuth');
        isAuthenticated = false;
        document.getElementById('loginSection').style.display = 'flex';
        document.getElementById('headerControls').style.display = 'none';
        document.getElementById('mainContent').classList.remove('active');
        document.getElementById('passwordInput').value = '';
    }

    function showMainContent() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('headerControls').style.display = 'flex';
        document.getElementById('mainContent').classList.add('active');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  DATA LOADING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadPlansData() {
        try {
            const response = await fetch(
                `https://samsamanowitz.github.io/Wellness-Plan-Estimates/wellness-plans-data/plans.json?t=${Date.now()}`
            );
            if (!response.ok) throw new Error('Failed to fetch plans.json: ' + response.status);
            plansData = await response.json();

            // Ensure cancellation objects exist for each plan
            for (const key of Object.keys(plansData.plans)) {
                if (!plansData.plans[key].cancellation) {
                    plansData.plans[key].cancellation = { bundled: [], optional: [] };
                }
            }

            renderUI();
            updateAuditLogLink();
            updateTokenStatus();
        } catch (error) {
            showToast('Failed to load plans: ' + error.message, 'error');
            console.error('Load error:', error);
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  RENDER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderUI() {
        document.getElementById('enrollmentFeeFirst').value = plansData.settings.enrollmentFeeFirst;
        document.getElementById('enrollmentFeeAdditional').value = plansData.settings.enrollmentFeeAdditional;

        const lastUpdated = new Date(plansData.metadata.lastUpdated);
        document.getElementById('lastUpdated').textContent = 'Updated ' + lastUpdated.toLocaleDateString() + ' ' + lastUpdated.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

        updateTokenStatus();

        document.getElementById('caninePlans').innerHTML =
            ['puppy', 'canineAdult'].map(key => renderPlanCard(key, plansData.plans[key])).join('');
        document.getElementById('felinePlans').innerHTML =
            ['kitten', 'felineAdult'].map(key => renderPlanCard(key, plansData.plans[key])).join('');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
    }

    function renderPlanCard(planKey, plan) {
        const icon = plan.species === 'canine' ? 'üêï' : 'üêà';
        const cxl = plan.cancellation || { bundled: [], optional: [] };

        // ‚îÄ‚îÄ Estimate Included Services ‚îÄ‚îÄ
        const estIncludedHTML = plan.included.map(svc => `
            <div class="service-item">
                <div class="service-info">
                    <div class="service-name-text">${escapeHtml(svc.name)}</div>
                    <div class="service-meta">
                        <span class="service-code-badge">${escapeHtml(svc.id)}</span>
                        <span class="service-qty-badge">Qty: ${escapeHtml(svc.qty || 'N/A')}</span>
                    </div>
                </div>
                <div></div>
                <div class="service-actions">
                    <button class="btn-icon" title="Edit" onclick="editEstIncluded('${planKey}','${escapeHtml(svc.id)}')">‚úèÔ∏è</button>
                    <button class="btn-icon delete" title="Delete" onclick="deleteService('${planKey}','${escapeHtml(svc.id)}','included','${escapeHtml(svc.name)}')">üóë</button>
                </div>
            </div>
        `).join('');

        // ‚îÄ‚îÄ Estimate Optional Services ‚îÄ‚îÄ
        const estOptionalHTML = plan.optional.map(svc => `
            <div class="service-item">
                <div class="service-info">
                    <div class="service-name-text">${escapeHtml(svc.name)}${svc.includesNote ? ` <span class="service-note">(${escapeHtml(svc.includesNote)})</span>` : ''}</div>
                    <div class="service-meta">
                        <span class="service-code-badge">${escapeHtml(svc.id)}</span>
                        <span class="service-qty-badge">Qty: ${svc.qty}</span>
                    </div>
                </div>
                <div class="service-pricing">
                    <div class="price-monthly">$${svc.cost.toFixed(2)}/mo</div>
                    ${svc.retailPrice ? `<div class="price-label">Retail: $${svc.retailPrice.toFixed(2)}</div>` : ''}
                </div>
                <div class="service-actions">
                    <button class="btn-icon" title="Edit" onclick="editEstOptional('${planKey}','${escapeHtml(svc.id)}')">‚úèÔ∏è</button>
                    <button class="btn-icon delete" title="Delete" onclick="deleteService('${planKey}','${escapeHtml(svc.id)}','optional','${escapeHtml(svc.name)}')">üóë</button>
                </div>
            </div>
        `).join('');

        // ‚îÄ‚îÄ Cancellation Bundled Services ‚îÄ‚îÄ
        const cxlBundledHTML = cxl.bundled.map(svc => `
            <div class="service-item cancel-item">
                <div class="service-info">
                    <div class="service-name-text">${escapeHtml(svc.name)}</div>
                    <div class="service-meta">
                        <span class="service-code-badge">${escapeHtml(svc.code)}</span>
                        ${svc.note ? `<span class="service-note">${escapeHtml(svc.note)}</span>` : ''}
                    </div>
                </div>
                <div class="service-pricing">
                    <div class="price-retail">$${svc.retailPrice.toFixed(2)}</div>
                    <div class="price-label">Retail</div>
                </div>
                <div class="service-actions">
                    <button class="btn-icon" title="Edit" onclick="editCxlBundled('${planKey}','${escapeHtml(svc.code)}')">‚úèÔ∏è</button>
                    <button class="btn-icon delete" title="Delete" onclick="deleteCxlService('${planKey}','${escapeHtml(svc.code)}','bundled','${escapeHtml(svc.name)}')">üóë</button>
                </div>
            </div>
        `).join('');

        // ‚îÄ‚îÄ Cancellation Optional Services ‚îÄ‚îÄ
        const cxlOptionalHTML = cxl.optional.map(svc => `
            <div class="service-item cancel-item">
                <div class="service-info">
                    <div class="service-name-text">${escapeHtml(svc.name)}</div>
                    <div class="service-meta">
                        <span class="service-code-badge">${escapeHtml(svc.code)}</span>
                        ${svc.note ? `<span class="service-note">${escapeHtml(svc.note)}</span>` : ''}
                    </div>
                </div>
                <div class="service-pricing">
                    <div class="price-retail">$${svc.retailPrice.toFixed(2)}</div>
                    <div class="price-label">Retail</div>
                </div>
                <div class="service-actions">
                    <button class="btn-icon" title="Edit" onclick="editCxlOptional('${planKey}','${escapeHtml(svc.code)}')">‚úèÔ∏è</button>
                    <button class="btn-icon delete" title="Delete" onclick="deleteCxlService('${planKey}','${escapeHtml(svc.code)}','optional','${escapeHtml(svc.name)}')">üóë</button>
                </div>
            </div>
        `).join('');

        return `
        <div class="plan-card">
            <div class="plan-card-header">
                <h3><span class="plan-icon">${icon}</span> ${escapeHtml(plan.displayName)}</h3>
            </div>

            <div class="base-cost-bar">
                <label>Monthly Base Cost</label>
                <span class="dollar">$</span>
                <input type="number" id="${planKey}_baseCost" value="${plan.baseCost.toFixed(2)}" step="0.01" min="0">
                <span class="permonth">/ month</span>
                <button class="btn btn-save-cost btn-sm" onclick="saveBaseCost('${planKey}')">Save</button>
            </div>

            <div class="plan-tabs">
                <button class="tab-btn active-estimate" id="${planKey}_tabEstimate" onclick="switchTab('${planKey}','estimate')">Estimate Services</button>
                <button class="tab-btn" id="${planKey}_tabCancel" onclick="switchTab('${planKey}','cancel')">Cancellation Services</button>
            </div>

            <!-- Estimate Tab -->
            <div class="tab-content active" id="${planKey}_contentEstimate">
                <div class="service-group">
                    <div class="service-group-header">
                        <span class="service-group-title estimate">Included Services</span>
                        <button class="btn btn-add btn-sm" onclick="addEstIncluded('${planKey}')">+ Add Included</button>
                    </div>
                    ${estIncludedHTML || '<p style="color:var(--gray-400);font-size:13px;padding:8px 0;">No included services configured.</p>'}
                </div>
                <div class="service-group">
                    <div class="service-group-header">
                        <span class="service-group-title estimate">Optional Add-On Services</span>
                        <button class="btn btn-add btn-sm" onclick="addEstOptional('${planKey}')">+ Add Optional</button>
                    </div>
                    ${estOptionalHTML || '<p style="color:var(--gray-400);font-size:13px;padding:8px 0;">No optional services configured.</p>'}
                </div>
            </div>

            <!-- Cancellation Tab -->
            <div class="tab-content cancel-tab" id="${planKey}_contentCancel">
                <div class="service-group">
                    <div class="service-group-header">
                        <span class="service-group-title cancel">Bundled Services (Retail Prices)</span>
                        <button class="btn btn-add btn-sm" onclick="addCxlBundled('${planKey}')">+ Add Bundled</button>
                    </div>
                    ${cxlBundledHTML || '<p style="color:var(--gray-400);font-size:13px;padding:8px 0;">No bundled services configured.</p>'}
                </div>
                <div class="service-group">
                    <div class="service-group-header">
                        <span class="service-group-title cancel">Optional Services (Retail Prices)</span>
                        <button class="btn btn-add btn-sm" onclick="addCxlOptional('${planKey}')">+ Add Optional</button>
                    </div>
                    ${cxlOptionalHTML || '<p style="color:var(--gray-400);font-size:13px;padding:8px 0;">No optional services configured.</p>'}
                </div>
            </div>
        </div>`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TABS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function switchTab(planKey, tab) {
        const estBtn = document.getElementById(planKey + '_tabEstimate');
        const cxlBtn = document.getElementById(planKey + '_tabCancel');
        const estContent = document.getElementById(planKey + '_contentEstimate');
        const cxlContent = document.getElementById(planKey + '_contentCancel');

        if (tab === 'estimate') {
            estBtn.className = 'tab-btn active-estimate';
            cxlBtn.className = 'tab-btn';
            estContent.classList.add('active');
            cxlContent.classList.remove('active');
        } else {
            estBtn.className = 'tab-btn';
            cxlBtn.className = 'tab-btn active-cancel';
            estContent.classList.remove('active');
            cxlContent.classList.add('active');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SAVE BASE COST & SETTINGS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function saveBaseCost(planKey) {
        const input = document.getElementById(planKey + '_baseCost');
        const newCost = parseFloat(input.value);
        if (isNaN(newCost) || newCost < 0) { showToast('Invalid cost value', 'error'); return; }
        const oldCost = plansData.plans[planKey].baseCost;
        plansData.plans[planKey].baseCost = newCost;
        await commitChanges(`Update ${plansData.plans[planKey].displayName} base cost from $${oldCost.toFixed(2)} to $${newCost.toFixed(2)}`);
    }

    async function saveSetting(settingKey) {
        const input = document.getElementById(settingKey);
        const newValue = parseFloat(input.value);
        if (isNaN(newValue) || newValue < 0) { showToast('Invalid value', 'error'); return; }
        const oldValue = plansData.settings[settingKey];
        plansData.settings[settingKey] = newValue;
        const name = settingKey === 'enrollmentFeeFirst' ? 'First Pet Enrollment Fee' : 'Additional Pet Enrollment Fee';
        await commitChanges(`Update ${name} from $${oldValue.toFixed(2)} to $${newValue.toFixed(2)}`);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MODAL HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showModalFields(mode) {
        // Show/hide form groups based on mode
        const fgCode = document.getElementById('fg_code');
        const fgEstFields = document.getElementById('fg_estimate_fields');
        const fgQtyOnly = document.getElementById('fg_qty_only');
        const fgRetail = document.getElementById('fg_retail');
        const fgNote = document.getElementById('fg_note');

        // Reset all
        fgCode.style.display = 'block';
        fgEstFields.style.display = 'none';
        fgQtyOnly.style.display = 'none';
        fgRetail.style.display = 'none';
        fgNote.style.display = 'block';

        if (mode.includes('EstIncluded')) {
            // Estimate Included: code, name, qty
            fgQtyOnly.style.display = 'block';
            fgNote.style.display = 'none';
        } else if (mode.includes('EstOptional')) {
            // Estimate Optional: code, name, cost, qty, note (as includesNote), retailPrice
            fgEstFields.style.display = 'grid';
            fgRetail.style.display = 'block';
        } else if (mode.includes('Cxl')) {
            // Cancellation (bundled or optional): code, name, retailPrice, note
            fgRetail.style.display = 'block';
        }
    }

    function clearModal() {
        document.getElementById('modalServiceCode').value = '';
        document.getElementById('modalServiceCode').readOnly = false;
        document.getElementById('modalServiceName').value = '';
        document.getElementById('modalServiceCost').value = '';
        document.getElementById('modalServiceQty').value = '';
        document.getElementById('modalServiceQtyIncluded').value = '';
        document.getElementById('modalRetailPrice').value = '';
        document.getElementById('modalServiceNote').value = '';
    }

    function openModal() {
        document.getElementById('editServiceModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('editServiceModal').classList.remove('active');
        editingService = null;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ESTIMATE INCLUDED ‚Äî CRUD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function addEstIncluded(planKey) {
        editingService = { planKey, serviceId: null, mode: 'addEstIncluded' };
        clearModal();
        document.getElementById('modalTitle').textContent = 'Add Included Service';
        document.getElementById('modalSaveBtn').textContent = 'Add Service';
        showModalFields('EstIncluded');
        openModal();
        document.getElementById('modalServiceCode').focus();
    }

    function editEstIncluded(planKey, serviceId) {
        const svc = plansData.plans[planKey].included.find(s => s.id === serviceId);
        if (!svc) return;
        editingService = { planKey, serviceId, mode: 'editEstIncluded' };
        clearModal();
        document.getElementById('modalTitle').textContent = 'Edit Included Service';
        document.getElementById('modalSaveBtn').textContent = 'Save Changes';
        document.getElementById('modalServiceCode').value = svc.id;
        document.getElementById('modalServiceCode').readOnly = true;
        document.getElementById('modalServiceName').value = svc.name;
        document.getElementById('modalServiceQtyIncluded').value = svc.qty || '';
        showModalFields('EstIncluded');
        openModal();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ESTIMATE OPTIONAL ‚Äî CRUD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function addEstOptional(planKey) {
        editingService = { planKey, serviceId: null, mode: 'addEstOptional' };
        clearModal();
        document.getElementById('modalTitle').textContent = 'Add Optional Service';
        document.getElementById('modalSaveBtn').textContent = 'Add Service';
        showModalFields('EstOptional');
        openModal();
        document.getElementById('modalServiceCode').focus();
    }

    function editEstOptional(planKey, serviceId) {
        const svc = plansData.plans[planKey].optional.find(s => s.id === serviceId);
        if (!svc) return;
        editingService = { planKey, serviceId, mode: 'editEstOptional' };
        clearModal();
        document.getElementById('modalTitle').textContent = 'Edit Optional Service';
        document.getElementById('modalSaveBtn').textContent = 'Save Changes';
        document.getElementById('modalServiceCode').value = svc.id;
        document.getElementById('modalServiceCode').readOnly = true;
        document.getElementById('modalServiceName').value = svc.name;
        document.getElementById('modalServiceCost').value = svc.cost;
        document.getElementById('modalServiceQty').value = svc.qty;
        document.getElementById('modalRetailPrice').value = svc.retailPrice || '';
        document.getElementById('modalServiceNote').value = svc.includesNote || '';
        showModalFields('EstOptional');
        openModal();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CANCELLATION BUNDLED ‚Äî CRUD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function addCxlBundled(planKey) {
        editingService = { planKey, serviceId: null, mode: 'addCxlBundled' };
        clearModal();
        document.getElementById('modalTitle').textContent = 'Add Bundled Service (Cancellation)';
        document.getElementById('modalSaveBtn').textContent = 'Add Service';
        showModalFields('CxlBundled');
        openModal();
        document.getElementById('modalServiceCode').focus();
    }

    function editCxlBundled(planKey, serviceCode) {
        const svc = plansData.plans[planKey].cancellation.bundled.find(s => s.code === serviceCode);
        if (!svc) return;
        editingService = { planKey, serviceId: serviceCode, mode: 'editCxlBundled' };
        clearModal();
        document.getElementById('modalTitle').textContent = 'Edit Bundled Service (Cancellation)';
        document.getElementById('modalSaveBtn').textContent = 'Save Changes';
        document.getElementById('modalServiceCode').value = svc.code;
        document.getElementById('modalServiceCode').readOnly = true;
        document.getElementById('modalServiceName').value = svc.name;
        document.getElementById('modalRetailPrice').value = svc.retailPrice;
        document.getElementById('modalServiceNote').value = svc.note || '';
        showModalFields('CxlBundled');
        openModal();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CANCELLATION OPTIONAL ‚Äî CRUD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function addCxlOptional(planKey) {
        editingService = { planKey, serviceId: null, mode: 'addCxlOptional' };
        clearModal();
        document.getElementById('modalTitle').textContent = 'Add Optional Service (Cancellation)';
        document.getElementById('modalSaveBtn').textContent = 'Add Service';
        showModalFields('CxlOptional');
        openModal();
        document.getElementById('modalServiceCode').focus();
    }

    function editCxlOptional(planKey, serviceCode) {
        const svc = plansData.plans[planKey].cancellation.optional.find(s => s.code === serviceCode);
        if (!svc) return;
        editingService = { planKey, serviceId: serviceCode, mode: 'editCxlOptional' };
        clearModal();
        document.getElementById('modalTitle').textContent = 'Edit Optional Service (Cancellation)';
        document.getElementById('modalSaveBtn').textContent = 'Save Changes';
        document.getElementById('modalServiceCode').value = svc.code;
        document.getElementById('modalServiceCode').readOnly = true;
        document.getElementById('modalServiceName').value = svc.name;
        document.getElementById('modalRetailPrice').value = svc.retailPrice;
        document.getElementById('modalServiceNote').value = svc.note || '';
        showModalFields('CxlOptional');
        openModal();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SAVE SERVICE EDIT (UNIFIED)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function saveServiceEdit() {
        if (!editingService) return;
        const { planKey, serviceId, mode } = editingService;
        const plan = plansData.plans[planKey];
        const code = document.getElementById('modalServiceCode').value.trim().toUpperCase();
        const name = document.getElementById('modalServiceName').value.trim();

        // Validate code
        if (!code) { showToast('Service code is required', 'error'); return; }
        if (!/^[A-Z0-9\-]+$/.test(code)) { showToast('Code must be uppercase letters, numbers, and hyphens', 'error'); return; }

        // Validate name
        if (!name) { showToast('Service name is required', 'error'); return; }
        if (name.length > 200) { showToast('Name too long (max 200 characters)', 'error'); return; }

        let commitMessage;

        // ‚îÄ‚îÄ ESTIMATE INCLUDED ‚îÄ‚îÄ
        if (mode === 'addEstIncluded') {
            if (plan.included.some(s => s.id === code)) { showToast('Code ' + code + ' already exists', 'error'); return; }
            const qty = document.getElementById('modalServiceQtyIncluded').value.trim();
            if (!qty) { showToast('Quantity is required', 'error'); return; }
            plan.included.push({ id: code, name, qty });
            commitMessage = `Add included service to ${plan.displayName}: ${name} (${code})`;

        } else if (mode === 'editEstIncluded') {
            const svc = plan.included.find(s => s.id === serviceId);
            const qty = document.getElementById('modalServiceQtyIncluded').value.trim();
            if (!qty) { showToast('Quantity is required', 'error'); return; }
            svc.name = name;
            svc.qty = qty;
            commitMessage = `Update ${plan.displayName} included service: ${name} (${code})`;

        // ‚îÄ‚îÄ ESTIMATE OPTIONAL ‚îÄ‚îÄ
        } else if (mode === 'addEstOptional') {
            if (plan.optional.some(s => s.id === code)) { showToast('Code ' + code + ' already exists', 'error'); return; }
            const cost = parseFloat(document.getElementById('modalServiceCost').value);
            const qty = document.getElementById('modalServiceQty').value.trim();
            const retailPrice = parseFloat(document.getElementById('modalRetailPrice').value) || undefined;
            const note = document.getElementById('modalServiceNote').value.trim();
            if (isNaN(cost) || cost < 0) { showToast('Valid cost required', 'error'); return; }
            if (!qty) { showToast('Quantity is required', 'error'); return; }
            const newSvc = { id: code, name, cost, qty: parseInt(qty) || qty };
            if (retailPrice) newSvc.retailPrice = retailPrice;
            if (note) newSvc.includesNote = note;
            plan.optional.push(newSvc);
            commitMessage = `Add optional service to ${plan.displayName}: ${name} (${code}) - $${cost.toFixed(2)}/mo`;

        } else if (mode === 'editEstOptional') {
            const svc = plan.optional.find(s => s.id === serviceId);
            const cost = parseFloat(document.getElementById('modalServiceCost').value);
            const qty = document.getElementById('modalServiceQty').value.trim();
            const retailPrice = parseFloat(document.getElementById('modalRetailPrice').value) || undefined;
            const note = document.getElementById('modalServiceNote').value.trim();
            if (isNaN(cost) || cost < 0) { showToast('Valid cost required', 'error'); return; }
            if (!qty) { showToast('Quantity is required', 'error'); return; }
            const oldCost = svc.cost;
            svc.name = name;
            svc.cost = cost;
            svc.qty = parseInt(qty) || qty;
            svc.retailPrice = retailPrice;
            svc.includesNote = note || undefined;
            commitMessage = `Update ${plan.displayName} - ${name} (${code}) from $${oldCost.toFixed(2)} to $${cost.toFixed(2)}`;

        // ‚îÄ‚îÄ CANCELLATION BUNDLED ‚îÄ‚îÄ
        } else if (mode === 'addCxlBundled') {
            if (plan.cancellation.bundled.some(s => s.code === code)) { showToast('Code ' + code + ' already exists', 'error'); return; }
            const retailPrice = parseFloat(document.getElementById('modalRetailPrice').value);
            if (isNaN(retailPrice) || retailPrice < 0) { showToast('Valid retail price required', 'error'); return; }
            const note = document.getElementById('modalServiceNote').value.trim();
            plan.cancellation.bundled.push({ code, name, retailPrice, note: note || '' });
            commitMessage = `Add cancellation bundled service to ${plan.displayName}: ${name} (${code}) - $${retailPrice.toFixed(2)} retail`;

        } else if (mode === 'editCxlBundled') {
            const svc = plan.cancellation.bundled.find(s => s.code === serviceId);
            const retailPrice = parseFloat(document.getElementById('modalRetailPrice').value);
            if (isNaN(retailPrice) || retailPrice < 0) { showToast('Valid retail price required', 'error'); return; }
            const note = document.getElementById('modalServiceNote').value.trim();
            const oldPrice = svc.retailPrice;
            svc.name = name;
            svc.retailPrice = retailPrice;
            svc.note = note || '';
            commitMessage = `Update ${plan.displayName} cancellation bundled: ${name} (${code}) from $${oldPrice.toFixed(2)} to $${retailPrice.toFixed(2)}`;

        // ‚îÄ‚îÄ CANCELLATION OPTIONAL ‚îÄ‚îÄ
        } else if (mode === 'addCxlOptional') {
            if (plan.cancellation.optional.some(s => s.code === code)) { showToast('Code ' + code + ' already exists', 'error'); return; }
            const retailPrice = parseFloat(document.getElementById('modalRetailPrice').value);
            if (isNaN(retailPrice) || retailPrice < 0) { showToast('Valid retail price required', 'error'); return; }
            const note = document.getElementById('modalServiceNote').value.trim();
            plan.cancellation.optional.push({ code, name, retailPrice, note: note || '' });
            commitMessage = `Add cancellation optional service to ${plan.displayName}: ${name} (${code}) - $${retailPrice.toFixed(2)} retail`;

        } else if (mode === 'editCxlOptional') {
            const svc = plan.cancellation.optional.find(s => s.code === serviceId);
            const retailPrice = parseFloat(document.getElementById('modalRetailPrice').value);
            if (isNaN(retailPrice) || retailPrice < 0) { showToast('Valid retail price required', 'error'); return; }
            const note = document.getElementById('modalServiceNote').value.trim();
            const oldPrice = svc.retailPrice;
            svc.name = name;
            svc.retailPrice = retailPrice;
            svc.note = note || '';
            commitMessage = `Update ${plan.displayName} cancellation optional: ${name} (${code}) from $${oldPrice.toFixed(2)} to $${retailPrice.toFixed(2)}`;
        }

        await commitChanges(commitMessage);
        closeModal();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  DELETE SERVICES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function deleteService(planKey, serviceId, serviceType, serviceName) {
        deletingService = { planKey, serviceId, serviceType, serviceName, context: 'estimate' };
        document.getElementById('deleteConfirmText').textContent =
            `Are you sure you want to delete "${serviceName}" (${serviceId}) from ${plansData.plans[planKey].displayName}?`;
        document.getElementById('deleteConfirmModal').classList.add('active');
    }

    function deleteCxlService(planKey, serviceCode, serviceType, serviceName) {
        deletingService = { planKey, serviceId: serviceCode, serviceType, serviceName, context: 'cancellation' };
        document.getElementById('deleteConfirmText').textContent =
            `Are you sure you want to delete "${serviceName}" (${serviceCode}) from ${plansData.plans[planKey].displayName} cancellation services?`;
        document.getElementById('deleteConfirmModal').classList.add('active');
    }

    function closeDeleteModal() {
        document.getElementById('deleteConfirmModal').classList.remove('active');
        deletingService = null;
    }

    async function confirmDelete() {
        if (!deletingService) return;
        const { planKey, serviceId, serviceType, serviceName, context } = deletingService;
        const plan = plansData.plans[planKey];

        if (context === 'estimate') {
            plan[serviceType] = plan[serviceType].filter(s => s.id !== serviceId);
        } else {
            plan.cancellation[serviceType] = plan.cancellation[serviceType].filter(s => s.code !== serviceId);
        }

        const commitMessage = `Delete ${context} ${serviceType} service from ${plan.displayName}: ${serviceName} (${serviceId})`;
        closeDeleteModal();
        await commitChanges(commitMessage);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  COMMIT CHANGES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function commitChanges(message) {
        try {
            const workflowToken = getWorkflowToken();
            if (!workflowToken) {
                const setup = confirm(
                    'First-time setup required.\n\nConfigure workflow trigger token?\n\n(Only needed once - see ADMIN_SETUP.md for instructions)'
                );
                if (setup) setupWorkflowToken();
                return;
            }

            showToast('Saving changes...', 'info');

            plansData.metadata.lastUpdated = new Date().toISOString();
            plansData.metadata.version = '2026.3';

            const response = await fetch(
                `${GITHUB_API}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/dispatches`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${workflowToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        event_type: 'update-pricing',
                        client_payload: {
                            data: plansData,
                            commit_message: message,
                            timestamp: new Date().toISOString()
                        }
                    })
                }
            );

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Token expired or invalid. Please reconfigure.');
                }
                const errorText = await response.text();
                throw new Error('GitHub API error: ' + response.status + ' - ' + errorText);
            }

            showToast('Changes submitted! Updates will appear in 30-60 seconds.', 'success');

            setTimeout(async () => {
                showToast('Refreshing data...', 'info');
                await loadPlansData();
                showToast('Pricing updated successfully!', 'success');
            }, 15000);

        } catch (error) {
            console.error('Save failed:', error);
            showToast('Failed: ' + error.message, 'error');

            if (error.message.includes('Token')) {
                const retry = confirm('Token issue detected.\n\nReconfigure workflow token?');
                if (retry) {
                    localStorage.removeItem('workflow_trigger_token');
                    setupWorkflowToken();
                }
            }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  UTILITIES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateAuditLogLink() {
        const link = `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/commits/main/wellness-plans-data/plans.json`;
        document.getElementById('auditLogLink').href = link;
    }

    function updateTokenStatus() {
        const el = document.getElementById('tokenStatusText');
        if (getWorkflowToken()) {
            el.textContent = '‚úÖ Configured';
            el.style.color = 'var(--green-500)';
        } else {
            el.textContent = '‚ùå Not configured';
            el.style.color = 'var(--red-500)';
        }
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'toastIn 0.3s ease-out reverse';
            setTimeout(() => toast.remove(), 300);
        }, 3500);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.addEventListener('DOMContentLoaded', function() {
        if (isAuthenticated) {
            loadPlansData().then(showMainContent);
        }
    });
</script>
</body>
</html>
